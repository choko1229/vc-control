<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>{{ guild.name }} - VC詳細</title>
  <link rel="stylesheet" href="/static/style.css">
</head>
<body>
  <header>
    <div class="logo">
      <div class="logo-mark"></div>
      <div>VC Dashboard</div>
    </div>
    <a class="cta-button secondary" href="/">ホームに戻る</a>
  </header>

  <main class="container">
    <section class="hero">
      <div>
        <h1>{{ guild.name }}</h1>
        <p>Discord 風のカードでボイスチャンネル状況を一覧化。リアルタイムで参加メンバーが更新されます。</p>
        <div class="badge">チャンネル数: {{ vc_list|length }} / 履歴 {{ sessions|length }} 件</div>
      </div>
      <div class="card">
        <h3>現在のステータス</h3>
        <div id="vc-overview">
          {% if vc_list %}
            {% for vc in vc_list %}
              <div class="kv"><span>{{ vc.name }}</span><span>{{ vc.members|length }} 名</span></div>
            {% endfor %}
          {% else %}
            <div class="empty-state">ボイスチャンネルがありません</div>
          {% endif %}
        </div>
      </div>
    </section>

    <h2 class="section-title">現在の VC</h2>
    <div class="grid" id="vc-list">
      {% for vc in vc_list %}
        <div class="card">
          <h3>{{ vc.name }}</h3>
          {% if vc.starter_name %}
            <div class="badge" style="margin:8px 0 4px;">開始ユーザー: {{ vc.starter_name }}</div>
          {% endif %}
          {% if vc.members %}
            <div class="pills">
              {% for member in vc.members %}
                <span class="pill">{{ member }}</span>
              {% endfor %}
            </div>
          {% else %}
            <div class="empty-state">誰もいません</div>
          {% endif %}
          {% if vc.can_manage or is_admin %}
            <div class="actions" style="margin-top:12px;">
              <a class="cta-button secondary" href="{{ vc.manage_url }}">このVCを管理</a>
            </div>
          {% endif %}
        </div>
      {% else %}
        <div class="card empty-state">ボイスチャンネルがありません。</div>
      {% endfor %}
    </div>

    <h2 class="section-title">最近の VC 履歴（最大50件）</h2>
    {% if sessions %}
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>VC名</th>
              <th>開始時刻</th>
              <th>終了時刻</th>
              <th>継続時間(秒)</th>
              <th>参加ユーザー</th>
            </tr>
          </thead>
          <tbody>
            {% for s in sessions %}
              <tr>
                <td>{{ loop.index }}</td>
                <td>{{ s.vc_name }}</td>
                <td>{{ s.started_at }}</td>
                <td>{{ s.ended_at }}</td>
                <td>{{ s.duration_sec }}</td>
                <td>
                  {% if s.participants %}
                    <div class="pills">
                      {% for uid, p in s.participants.items() %}
                        <span class="pill">{{ p.name }}（{{ p.total_sec }}秒）</span>
                      {% endfor %}
                    </div>
                  {% else %}
                    <span class="guild-meta">-</span>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="card empty-state">まだ履歴はありません。</div>
    {% endif %}
  </main>

  <script>
    (function() {
      const guildId = {{ guild.id }};
      const vcListDiv = document.getElementById("vc-list");
      const vcOverview = document.getElementById("vc-overview");

      const protocol = (location.protocol === "https:") ? "wss://" : "ws://";
      const wsUrl = protocol + location.host + "/ws";
      const ws = new WebSocket(wsUrl);

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          if (data.type !== "vc_update") return;

          const guilds = data.guilds || [];
          const g = guilds.find(x => x.id === guildId);
          if (!g) return;

          const listParts = [];
          if (g.vcs.length === 0) {
            listParts.push('<div class="card empty-state">ボイスチャンネルがありません。</div>');
          } else {
            for (const vc of g.vcs) {
              const members = (vc.members && vc.members.length)
                ? vc.members.map(m => `<span class="pill">${m}</span>`).join("")
                : '<div class="empty-state">誰もいません</div>';
              listParts.push(`<div class="card"><h3>${vc.name}</h3>${members.startsWith('<div') ? members : `<div class="pills">${members}</div>`}</div>`);
            }
          }
          vcListDiv.innerHTML = listParts.join("");

          const overviewParts = [];
          if (g.vcs.length === 0) {
            overviewParts.push('<div class="empty-state">ボイスチャンネルがありません</div>');
          } else {
            for (const vc of g.vcs) {
              const count = (vc.members && vc.members.length) ? vc.members.length : 0;
              overviewParts.push(`<div class="kv"><span>${vc.name}</span><span>${count} 名</span></div>`);
            }
          }
          vcOverview.innerHTML = overviewParts.join("");
        } catch (e) {
          console.error("WebSocket message parse error:", e);
        }
      };
    })();
  </script>
</body>
</html>
